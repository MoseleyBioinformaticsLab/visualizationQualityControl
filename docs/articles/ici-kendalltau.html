<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Information-Content-Informed Kendall Tau Correlation • visualizationQualityControl</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Information-Content-Informed Kendall Tau Correlation">
<meta property="og:description" content="visualizationQualityControl">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">visualizationQualityControl</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.72</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ici-kendalltau.html">Information-Content-Informed Kendall Tau Correlation</a>
    </li>
    <li>
      <a href="../articles/pca_testing.html">PCA Testing</a>
    </li>
    <li>
      <a href="../articles/quality_control.html">Quality Control Example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ici-kendalltau_files/header-attrs-2.3/header-attrs.js"></script><script src="ici-kendalltau_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Information-Content-Informed Kendall Tau Correlation</h1>
                        <h4 class="author">Robert M Flight &amp; Hunter NB Moseley</h4>
            
      
      
      <div class="hidden name"><code>ici-kendalltau.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw">visualizationQualityControl</span>)
</pre></div>
<div id="problem" class="section level2">
<h2 class="hasAnchor">
<a href="#problem" class="anchor"></a>Problem</h2>
<ul>
<li>How to handle missing data (i.e. <code>NA</code>’s) in calculating a correlation between two variables.</li>
<li>Current calculations of correlation are based on having all pairs of observations for two variables.
<ul>
<li>However, whether an observation is made is semi-quantitative information for many analytical measurements with sensitivity limits.</li>
<li>i.e. in many cases, missing observations are not “missing-at-random”, but “missing-not-at-random” due to falling below the detection limit.</li>
<li>In these cases, NA is informative.</li>
</ul>
</li>
</ul>
</div>
<div id="approach" class="section level2">
<h2 class="hasAnchor">
<a href="#approach" class="anchor"></a>Approach</h2>
<p>A <a href="https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient">Kendall Tau Correlation coefficient</a> calculates correlation based on the number of concordant and discordant pairs:</p>
<ul>
<li><span class="math inline">\(\tau = \frac{ | pairs_{concordant} | - | pairs_{discordant} |}{\binom{n}{2}}\)</span></li>
<li>A pair are two x-y data points.</li>
<li>A concordant pair has the following classical definition:
<ul>
<li>
<span class="math inline">\(x_i &gt; x_j\)</span> and <span class="math inline">\(y_i &gt; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i &lt; x_j\)</span> and <span class="math inline">\(y_i &lt; y_j\)</span>
</li>
</ul>
</li>
<li>A discordant pair has the following classical definition:
<ul>
<li>
<span class="math inline">\(x_i &gt; x_j\)</span> and <span class="math inline">\(y_i &lt; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i &lt; x_j\)</span> and <span class="math inline">\(y_i &gt; y_j\)</span>
</li>
</ul>
</li>
</ul>
<p><em>But these definitions can be expanded to handle missing observations:</em></p>
<ul>
<li>Information content informed concordant pairs:
<ul>
<li>
<span class="math inline">\(x_i &gt; x_j\)</span> and <span class="math inline">\(y_i &gt; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i &lt; x_j\)</span> and <span class="math inline">\(y_i &lt; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i &gt; x_j\)</span> and <span class="math inline">\(y_i \&amp; !y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i &lt; x_j\)</span> and <span class="math inline">\(!y_i \&amp; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i \&amp; !x_j\)</span> and <span class="math inline">\(y_i &gt; y_j\)</span>
</li>
<li>
<span class="math inline">\(!x_i \&amp; x_j\)</span> and <span class="math inline">\(y_i &lt; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i \&amp; !x_j\)</span> and <span class="math inline">\(y_i \&amp; !y_j\)</span> (not used in local perspective version)</li>
<li>
<span class="math inline">\(x_i \&amp; x_j\)</span> and <span class="math inline">\(!y_i \&amp; y_j\)</span> (not used in local perspective version)</li>
</ul>
</li>
<li>Information content informed discordant pairs:
<ul>
<li>
<span class="math inline">\(x_i &gt; x_j\)</span> and <span class="math inline">\(y_i &lt; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i &lt; x_j\)</span> and <span class="math inline">\(y_i &gt; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i &gt; x_j\)</span> and <span class="math inline">\(!y_i \&amp; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i &lt; x_j\)</span> and <span class="math inline">\(y_i \&amp; !y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i \&amp; !x_j\)</span> and <span class="math inline">\(y_i &lt; y_j\)</span>
</li>
<li>
<span class="math inline">\(!x_i \&amp; x_j\)</span> and <span class="math inline">\(y_i &gt; y_j\)</span>
</li>
<li>
<span class="math inline">\(x_i \&amp; !x_j\)</span> and <span class="math inline">\(!y_i \&amp; y_j\)</span> (not used in local perspective version)</li>
<li>
<span class="math inline">\(!x_i \&amp; x_j\)</span> and <span class="math inline">\(y_i \&amp; !y_j\)</span> (not used in local perspective version)</li>
</ul>
</li>
<li>Also data points with both missing x and y values will naturally reduce the strength of the correlation value, since they can be neither concordant nor discordant with another (NA, NA) pair, but will impact the denominator.</li>
<li>Alternatively, (NA,NA) points can be removed to calculate a correlation that is specific to the two variables and does not consider missing data from a global dataset perspective that spans a set of variables.
<ul>
<li>If this local perspective is used, then two data points that are both missing data, should not be compared.
<ul>
<li>This is equivalent to removing the last two concordant and discordant pair tests.</li>
<li>It may be easier to just count them and then remove this count from the denominator. (See handling tied values below).</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div id="handling-tied-values" class="section level2">
<h2 class="hasAnchor">
<a href="#handling-tied-values" class="anchor"></a>Handling Tied Values</h2>
<p>The base Kendall tau correlation must be adjusted to handle tied values, ie. the <a href="https://en.wikipedia.org/wiki/Kendall_rank_correlation_coefficient#Accounting_for_ties">tau-b</a> version of the equation.</p>
<p><span class="math display">\[\tau = \frac{ | pairs_{concordant}  | -  | pairs_{discordant}  |}{\sqrt{ ( n_0 - n_{xtie}  )  ( n_0 - n_{ytie}  )}} \]</span> where:</p>
<ul>
<li><span class="math inline">\(n_0 = \frac{n \left ( n - 1 \right )}{2}\)</span></li>
<li><span class="math inline">\(n_{xtie} = \sum_{i}^{} \frac{t_{xi} \left ( t_{xi} - 1 \right )}{2}\)</span></li>
<li><span class="math inline">\(n_{ytie} = \sum_{i}^{} \frac{t_{yi} \left ( t_{yi} - 1 \right )}{2}\)</span></li>
<li>
<span class="math inline">\(t_{xi}\)</span> - the size of the ith group of tied x values.</li>
<li>
<span class="math inline">\(t_{yi}\)</span> - the size of the ith group of tied y values.</li>
<li>From the local perspective, the number of NAs in x and y can be treated as a group of tied values in calculation of <span class="math inline">\(n_{xtie}\)</span> and <span class="math inline">\(n_{ytie}\)</span>, respectively.</li>
</ul>
</div>
<div id="alternative-tau-b" class="section level2">
<h2 class="hasAnchor">
<a href="#alternative-tau-b" class="anchor"></a>Alternative Tau-b</h2>
<p><span class="math display">\[\tau = \frac{\left | pairs_{concordant} \right | - \left | pairs_{discordant} \right |}{\left | pairs_{concordant} \right | + \left | pairs_{discordant} \right | + \left | pairs_{xties} \right | + \left | pairs_{yties} \right |}\]</span></p>
<p>The nice thing about this, is based on the above definitions of concordant and discordant, I think this is directly the <em>local</em> version. Therefore, to get the <em>global</em> version, we count the ties of NA’s and other things, and appropriately inflate the <em>x</em> and <em>y</em> tie counts in the bottom.</p>
</div>
<div id="scaling-by-the-correlation-with-the-highest-information-content" class="section level2">
<h2 class="hasAnchor">
<a href="#scaling-by-the-correlation-with-the-highest-information-content" class="anchor"></a>Scaling by the correlation with the highest information content</h2>
<p>When generating a correlation matrix (heatmap) for large analytical datasets, the number of observations in common can become quite low between any two variables. It becomes advantageous to scale by the pair of variables with the highest information content. One objective scaling factor is the highest possible absolute correlation at the maximum information content observed across a dataset, and dividing by this maximum possible absolute correlation would scale the whole dataset appropriately.</p>
<p><span class="math display">\[maxcorr = \frac{\binom{n-m}{2} + n * m}{\binom{n-m}{2} + n * m + \binom{m}{2}}\]</span> Where:</p>
<ul>
<li>Choose the two variables with <em>the least number</em> of missing values across the dataset.</li>
<li>n is the length of the variables.</li>
<li>m is the count of missing values across the two variables divided by two rounded down.
<ul>
<li>This formula is based on perfect correlation with a given number of (NA,NA) pairs added.</li>
</ul>
</li>
</ul>
</div>
<div id="examples" class="section level2">
<h2 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h2>
</div>
<div id="speed" class="section level2">
<h2 class="hasAnchor">
<a href="#speed" class="anchor"></a>Speed</h2>
<p>Even with the main calculation written in C++, it still tends to be pretty slow. Faster than the pure R implementation (kept for reference in case of algorithmic modifications), but still slow.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1000</span>)
<span class="kw">y</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1000</span>)

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/joshuaulrich/microbenchmark">microbenchmark</a></span>)

<span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="kw">x</span>, <span class="kw">y</span>, method = <span class="st">"kendall"</span>),
  <span class="fu"><a href="../reference/kendallt.html">ici_kendallt</a></span>(<span class="kw">x</span>, <span class="kw">y</span>),
  <span class="kw">visualizationQualityControl</span>:::<span class="fu"><a href="../reference/ref_kendallt.html">ref_kendallt</a></span>(<span class="kw">x</span>, <span class="kw">y</span>),
  times = <span class="fl">5</span>
)
<span class="co">#&gt; Unit: milliseconds</span>
<span class="co">#&gt;                                              expr       min         lq</span>
<span class="co">#&gt;                     cor(x, y, method = "kendall")   13.5761   13.86954</span>
<span class="co">#&gt;                                ici_kendallt(x, y)  212.0416  216.26162</span>
<span class="co">#&gt;  visualizationQualityControl:::ref_kendallt(x, y) 1207.2518 1242.40566</span>
<span class="co">#&gt;        mean     median         uq        max neval</span>
<span class="co">#&gt;    14.23169   13.88212   14.01654   15.81416     5</span>
<span class="co">#&gt;   231.74232  221.62472  248.21222  260.57141     5</span>
<span class="co">#&gt;  1330.53925 1263.73655 1354.24603 1585.05620     5</span>
</pre></div>
<p>10X slower than the C implementation, but 10X faster than the base R implementation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span>(<span class="fu"><a href="../reference/kendallt.html">ici_kendallt</a></span>(<span class="kw">x</span>, <span class="kw">y</span>), <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="kw">x</span>, <span class="kw">y</span>, method = <span class="st">"kendall"</span>))
<span class="co">#&gt; [1] TRUE</span>
</pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Robert M Flight.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
